name: idea-loop

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  run-cycle:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install openai==1.51.2

      - name: Install codex CLI (替换为你的真实安装命令)
        run: |
          echo "Installing codex CLI..."
          # 示例：如果你有私有安装脚本，就在这里执行。否则注释掉并确保 runner 已有 codex 可执行文件。
          # curl -fsSL https://your-org.com/install-codex.sh | bash
          which codex || echo "WARNING: codex not found in PATH. Ensure it's preinstalled on runner."

      - name: Configure git
        run: |
          git config user.name "${{ secrets.GIT_AUTHOR_NAME }}"
          git config user.email "${{ secrets.GIT_AUTHOR_EMAIL }}"

      - name: Prepare codex config and auth
        env:
          NVAPI_KEY: ${{ secrets.NVAPI_KEY }}
        run: |
          mkdir -p $HOME/.codex
          cat > $HOME/.codex/config.toml << 'EOF'
          model = "moonshotai/kimi-k2-thinking"
          model_provider = "nvidia"
          preferred_auth_method = "env"  # 用环境变量，不把密钥写死进文件

          [model_providers.nvidia]
          name = "Nvidia"
          base_url = "https://integrate.api.nvidia.com/v1"
          wire_api = "responses"
          EOF

          # codex 常用是从 OPENAI_API_KEY 读取，指向 NVAPI key
          cat > $HOME/.codex/auth.json << EOF
          { "OPENAI_API_KEY": "${NVAPI_KEY}" }
          EOF

      - name: Run cycle
        env:
          NVAPI_KEY: ${{ secrets.NVAPI_KEY }}
          OPENAI_BASE_URL: "https://integrate.api.nvidia.com/v1"
          LLM_MODEL: "moonshotai/kimi-k2-thinking"
          MAX_IDEA_ROUNDS: "4"
          MAX_CHAIN_DEPTH: "2"   # 防止无限自触发；可按需调大或移除护栏
        run: |
          python scripts/run_cycle.py